<!DOCTYPE html>

<html>
<head>
<style>
*{padding: 0px; margin: 0px;}
#container{
width: 360px;
margin: 100px auto;
}
#sudoku{
width: 360px;
height: 360px;
}
#sudoku div{
width: 39px;
height: 39px;
display: inline-block;
border-top: 1px black solid;
border-left: 1px black solid;
text-align: center;
}
#sudoku div:nth-child(3n + 3){
	border-right: 1px black solid;
	width: 38px;
}
#sudoku div[data-y="2"], #sudoku div[data-y="5"], #sudoku div[data-y="8"]{
	border-bottom: 1px black solid;
	height: 38px;
}
#sudoku div input{
	width: 100%;
	height: 100%;
	border: 0px;
	font-size: 20px;
	text-align: center;
}
#sudoku div input:focus{
	background-color: #D6E1FF;
}
button{
	border: 1px black solid;
	background: #FFF;
	padding: 5px;
	cursor: pointer;
}
</style>
<script src="js/jquery.js"></script>

</head>
<body>
<div id="container">
	<div id="sudoku">
	</div>
	<button id="solve">Solve!</button><br/>
	<input type="checkbox" id="show"/><label for="show">Show how it's done (shows each step)</label>
	
</div>
<script>
$(document).ready(function(){
	var SUDOKU = (function(){
			var that = {};
			var curBox = null;//holds the current box object the user is focused on
			var invalidTextBox = null; //holds the current textbox with an invalid value (if there is any)
			var solveIncrementally = false;
			var checkbox, button;
			var boxStorage = new Array(81);/*array of boxes, defined as follows:
				{
					val: <number>
					textbox: <textbox>
					x: <number>
					y: <number>
				}
			*/
			function get(x,y){
				return boxStorage[y * 9 + x].val;
			}
			function set(x,y,val){
				boxStorage[y * 9 + x].val = val;
			}
			function getBox(x,y){
				x = parseInt(x);
				y = parseInt(y);
				//console.log(y * 9 + x);
				//console.log(boxStorage[y * 9 + x]);
				//console.log(boxStorage);
				return boxStorage[y * 9 + x];
			}
			/* sets both the internal value and the textbox value
				therefore the user can see the changes
			*/
			function setBox(x,y,val){
				$(boxStorage[y * 9 + x]).val(val);
				set(x,y,val);
			}
			function textBoxFocus(e){
				var targ = $(e.target);
				var parent = targ.parent();
				if(isNaN(targ.val()) || targ.val() == "0"){
					targ.val("");//clear it
				}

				curBox = getBox(parent.attr("data-x"), parent.attr("data-y"));
			}
			function textBoxBlur(e){
				//check if the box blurred is the current box
				if(curBox != null && curBox.textbox == e.target){
					//validate
					validate(curBox)
					curBox = null;
				}
			}
			function showFeedback(type, msg){
				console.log(type, msg);
			}
			function navigateFocus(dir){
				//get the current x-y coordinates that the user is in
				var curx = curBox.x,
					cury = curBox.y; 
				switch(dir){
					case 37:
						curx--;
					break;
					case 38:
						cury--;
					break;
					case 39:
						curx++;
					break;
					case 40:
						cury++;
					break;
					default:
						return;//nope
					break;
				}
				if(curx < 0 || curx > 8 || cury < 0 || cury > 8){
					return;//invalid
				}
				//otherwise focus on the new one
				console.log(curx,cury);
				$(getBox(curx, cury).textbox).focus();
			}
			function solve(){
				//recursively solve this
				
			}

			function isValid(box){
					return false;
			}
			/* if called with x,y parameters, the box at x,y is validated
				otherwise all boxes are validated
			*/
			function validate(x,y){
				if(x != null && y != null){
					//just validate one box
					if(!isValid(boxStorage[i])){
						invalidTextBox = boxStorage[i].textbox;
					}
				}
				else{
					//go through each box, set up each box in the array, set the vals
					for(var i = 0; i < 81; i++){
						var val = $(boxStorage[i].textbox).val();
						if(!isValid(boxStorage[i])){
							console.log("Invalid");
							invalidTextBox = boxStorage[i].textbox;
							break;
						}
					}
				}
				if(invalidTextBox != null){
					$(invalidTextBox).addClass("error");
					return false;
				}
			}

			function buttonClicked(){
				$(button).hide();	
				if(validate()){
					solve();
				}
				$(button).show();
			}

			function initUI(c){
				var frag = document.createDocumentFragment();
				for(var i = 0; i < 9; i++){
					for(var j = 0; j < 9; j++){
						//create body in jquery
						var box = $("<div>").addClass("box").attr("data-x", j).attr("data-y", i)[0],
							text = $("<input>").attr("type", "text").attr("maxlength", "1").on("focus", textBoxFocus).on("blur", textBoxBlur)[0];
						boxStorage[i * 9 + j] = {textbox: text, val: 0, x: j, y: i};
						box.appendChild(text);
						frag.appendChild(box);
					}
				}
				c.appendChild(frag);
				$(c).on("click", function(e){
					var targ = $(e.target);
					if(targ.hasClass("box")){
						targ.find("input").focus();
					}
				}).on("keydown", function(e){
					if(curBox != null){
						console.log(e.which);
						//ok then user might be trying to input a number
						//check if key is legit
						var character = String.fromCharCode(e.which);
						if(e.which >= 49 && e.which <= 57){
							//valid numeric 1-9
							$(curBox.textbox).val(character);
						}
						else{
							e.preventDefault();
							e.stopPropagation();
							//check if arrow key
							if(e.which >= 37 && e.which <= 40){
								navigateFocus(e.which);
							}
							else if(e.which == 8 || e.which == 46){
								console.log("Hey");
								//delete/backspace
								$(curBox.textbox).val("");
							}
							return false;
						}

					}
				});
			}
			that.init = function(stg){
				if(stg.hasOwnProperty("container")){
					initUI(stg.container);
				}
				if(stg.hasOwnProperty("button")){
					$(stg.button).on("click", buttonClicked);
					button = stg.button;
				}
				if(stg.hasOwnProperty("checkbox")){
					checkbox = stg.checkbox;
				}
			}
			return that;
	}());
	SUDOKU.init(
		{
			container: document.getElementById("sudoku"),
			button: document.getElementById("solve"),
			checkbox: document.getElementById("show")
		}
	); 
});
</script>
</body>

</html>
